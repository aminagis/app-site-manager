<!doctype html>
<html lang="en">
<head>
  <!-- Meta Tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <style>
    #map {
      height: 800px;
    }
  </style>

  

  
</head>
<body>

  <!-- Navigation -->
  <ul class="nav justify-content-end">
    <li class="nav-item">
      <a class="nav-link active" href="home.html">Home</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="map.html">Map</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="gestionnaire.html">Gestionnaire</a>
    </li>
    <li class="nav-item">
      <a class="nav-link " href="data.html">Data</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="profil.html">Profil</a>
    </li>
  </ul>

<br>

<div class="flouide">
    <div class="row">
        <div class="col-md-10">
              <!-- Map Container -->
             <div id="map">

         

             </div>








             <!--barre droite de la page map-->
        </div>
        <div class="col-md-2">
            <font style="color: purple;">
              <b>
            <label>Filter</label></b>
            

            <!--listes des entreprises-->

               <select id="inputEntreprise" class="form-control">
                 <option selected>Entreprise</option>
                 <option>Jesa</option>
                 <option>gardouz</option>
                 <option>cmatemeb</option>
                 <option>patrabl</option>
                 <option>arco ts</option>
                 <option>big indus</option>
                 <option>sogap</option>
                 <option>isofu</option>
                 <option>spaciba</option>
                 <option>sapem</option>
                 <option>spts</option>
                 <option>socadeleg</option>
                 <option>aster</option>
                 <option>lpee</option>
                 <option>europa</option>
                 <option>autres</option>
               </select><br>
                <!--ETATS-->
               <label for="inputetat">Etat</label>
                    <select id="inputetat" class="form-control">
                       <option selected>Planifier</option>
                       <option>annuler</option>
                       <option>Encours</option>
                    </select><br>
                <label for="inputsuper">Superviseur</label>
                    <select id="inputsuper" class="form-control">
                       <option>dahman</option>
                       <option>mohamed</option>
                       <option>autres</option>
                    </select>

                <div><br>
                    
                    <label for="iinputdt">Date des travaux</label>
                    <input type="date" class="form-control" id="inputdate" placeholder="jj/mm/aaaa">
                </div><br>
                
            <center>
                <button id="applyFilter" type="submit" class="btn btn-outline-success" > Appliquer</button>
            </center><br>

            <b>Boite à Ouetil</b>
              </font> 
        </div>

    </div>
</div>

 





























  <!-- JS: jQuery + Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>

  <!-- Map Initialization -->

  <!-- Map Initialization -->
  <script>
    var map = L.map('map').setView([33.1040023, -8.5998066], 13);

    // Default base layer
    var defaultLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    

    var esriSat = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        maxZoom: 19,
        attribution: 'Tiles © Esri'
      }
    );

    // Base map options
    var baseMaps = {
      "OpenStreetMap": defaultLayer,

      "Satellite": esriSat
    };

    // Layer control
    L.control.layers(baseMaps).addTo(map);


    // data testing

var geojsonData={
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "name": "MMG",
        "superviseur": "dahman",
        "CP": "X",
        "entreprise": "sogap",
        "zone": "MMG",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.588944037424795,
          33.107363991772985
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "PARKING B",
        "superviseur": "mohamed",
        "CP": "X",
        "entreprise": "gardouz",
        "zone": "PARKING B",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.600492415942256,
          33.11251306874648
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "13E",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "13E",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.603053503274168,
          33.11280346005252
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "CENTRAL",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "CENTRAL",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.601521943647697,
          33.10979742044155
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "N CENTRAL",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "CENTRAL",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.601629071236886,
          33.11052681771122
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "U07",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "U07",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.607561413918773,
          33.11136344764152
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.609721343583118,
          33.112063607552344
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "U51",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "U51",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.614287137809299,
          33.12018333501895
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "U53",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "U53",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.615204221318692,
          33.1201178114497
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "AMONIAC",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "AMONIAC",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.616869976869765,
          33.11844686991029
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name":"",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.599910643688702,
          33.11083439398443
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.60014333394517,
          33.110230762993666
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "U107D",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "U107D",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""

      },
      "geometry": {
        "coordinates": [
          -8.607199308546285,
          33.1101334322107
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "RACK20",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "RACK20",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.607905447961883,
          33.11654426273216
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "U116",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "U116",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.608750418356294,
          33.114986861475955
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "BLOC6",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "BLOC6",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.608627931721827,
          33.11306803957474
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "BLOC7",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "BLOC7",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.613716511345359,
          33.11221238857793
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "JFC2",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "JFC2",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.611896344514264,
          33.100812100949
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "JFC4",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "JFC4",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.608608802757175,
          33.09916372352242
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "JFC5",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "JFC5",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.604748816287696,
          33.101908052567055
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "KOFERT",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "KOFERT",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.59796621955445,
          33.098376213717614
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "JFC1",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "JFC1",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.595967337043732,
          33.1010351210989
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "TERMINALE",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "TERMINALE",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.595590061577525,
          33.09647279510597
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "TC",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "TC",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.591891381618524,
          33.10888306843252
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "UM6P",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "UM6P",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.593636537959128,
          33.11028395118798
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "MOSQUEE",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "MOSQUEE",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.597461782204448,
          33.11187758420843
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "DESSALEMENT",
        "superviseur": "",
        "CP": "X",
        "entreprise": "",
        "zone": "DESSALEMENT",
        "etat": "planifier",
        "nature travaux": "",
        "permis de fouille": "",
        "date fin": "",
        "permis EC": "",
        "mise a disposition": ""
      },
      "geometry": {
        "coordinates": [
          -8.600276187387351,
          33.11869409868902
        ],
        "type": "Point"
      }
    }
  ]
}
;
const colors = {
  encours: 'red',
  planifier: 'blue',
  annuler: '#08FF7F'
};

function createGeoJsonLayer(data) {
  return L.geoJSON(data, {
    pointToLayer: function(feature, latlng) {
      let color = colors[feature.properties.etat] || 'purple';
      return L.circleMarker(latlng, {
        radius: 8,
        fillColor: color,
        color: '#000',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      });
    },
    onEachFeature: function(feature, layer) {
      let p = feature.properties;
      
      // Fonction pour mettre à jour la popup
      function updatePopup() {
        layer.bindPopup(`
          <b>Superviseur :</b> ${p.superviseur || ''}<br>
          <b>Entreprise :</b> ${p.entreprise || ''}<br>
          <b>Zone :</b> ${p.zone || ''}<br>
          <b>État :</b> ${p.etat || ''}<br>
          <b>Nature travaux :</b> ${p["nature travaux"] || ''}<br>
        `);
      }

      // Premier affichage
      updatePopup();

      // Événement contextmenu pour modifier les données avec click droite 
      layer.on('contextmenu', function() {
        let newEtat = prompt("Nouvel état (encours, planifier, annuler) :", p.etat);
        if (newEtat) {
          p.etat = newEtat;
        }
        
        

        // Recréer le marqueur avec la nouvelle couleur
        let newColor = colors[p.etat] || 'purple';
        layer.setStyle({ fillColor: newColor });

        // Mettre à jour la popup
        updatePopup();
        layer.openPopup();
      });
    }
  });
}

// ---- Utilisation ----
let geoLayer = createGeoJsonLayer(geojsonData);
geoLayer.addTo(map);



// fileeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeer prendre d un autre model


document.getElementById('applyFilter').addEventListener('click', function () {
  // Récupérer les valeurs des filtres
  let selectedEntreprise = document.getElementById('inputEntreprise').value.toLowerCase();
  let selectedEtat = document.getElementById('inputetat').value.toLowerCase();
  let selectedSuperviseur = document.getElementById('inputsuper').value.toLowerCase();
  let selectedDate = document.getElementById('inputdate').value; // format: YYYY-MM-DD

  // Filtrer les features
  let filteredFeatures = geojsonData.features.filter(function (feature) {
    let p = feature.properties;

    // Normaliser les valeurs
    let entreprise = (p.entreprise || '').toLowerCase();
    let etat = (p.etat || '').toLowerCase();
    let superviseur = (p.superviseur || '').toLowerCase();
    let dateTravaux = p["date fin"]; // ou "mise a disposition" selon ton besoin

    let matchEntreprise = selectedEntreprise === "entreprise" || entreprise === selectedEntreprise;
    let matchEtat = selectedEtat === "planifier" || etat === selectedEtat;
    let matchSuperviseur = selectedSuperviseur === "autres" || superviseur === selectedSuperviseur;
    let matchDate = !selectedDate || dateTravaux === selectedDate;

    return matchEntreprise && matchEtat && matchSuperviseur && matchDate;
  });

  // Nettoyer l’ancienne couche
  if (geoLayer) {
    map.removeLayer(geoLayer);
  }

  // Créer une nouvelle couche filtrée
  let filteredData = {
    type: "FeatureCollection",
    features: filteredFeatures
  };

  geoLayer = createGeoJsonLayer(filteredData);
  geoLayer.addTo(map);
});







  </script>
</body>
</html>
